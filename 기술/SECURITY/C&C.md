# C&C

<https://www.koreascience.or.kr/article/JAKO201304164263926.pdf>
<https://www.itworld.co.kr/news/99886>
<https://www.boannews.com/media/view.asp?idx=52433>
<http://www.igloosec.co.kr/BLOG_VPNFilter%20%EC%95%85%EC%84%B1%EC%BD%94%EB%93%9C%20%EB%B6%84%EC%84%9D%20%EB%B3%B4%EA%B3%A0%EC%84%9C?searchItem=&searchWord=&bbsCateId=47&gotoPage=3>
<https://letitkang.tistory.com/131>

## Splunk

IP기준
avg(sess_gap) stdev(sess_gap), avg(duration)

1. Total Session 많다.
2. Avg Gap 15초

```bash
sourcetype=bluecoat_proxy
| streamstats current=f last(_time) as next_time by dest
| eval gap = next_time - _time
| stats count  avg(gap) as avg_gap, var(gap) as var_gap by dest src
| search avg_gap < 50 count > 500
| sort avg_gap
```

- count 높고, avg_gap(15초) 낮고, var_gap 낮음

## 뉴스

"너는 이미 침입 당했다"...네트워크 침입 탐지법 5가지
Kasey Cross | Network World
* 본 기고문은 업체 관계자가 작성한 것이지만 업체 솔루션이나 시각과 관련한 내용을 직접 포함하지 않도록 네트워크 월드 편집진의 수정을 거쳤다.

일부 자료를 보면 공격자가 이미 침입해 있는 네트워크가 전체의 96%에 달한다. 따라서 권한을 단계적으로 탈취하고 주요 정보를 찾아 훔치기 전에 이를 파악해 막아야 한다.

사이버 공격은 엔드포인트 시스템을 감염시키거나 장악하는 것으로 끝나지 않는다. 이것은 시작일 뿐이다. 이때부터 본격적인 공격이 시작되므로, 공격자를 찾는 방법만 정확히 알면 막을 수 있다. 공격자가 네트워크에 들어왔을 때 이에 대응하는 전략을 소개한다.

1. 침해를 알려주는 신호를 찾는다
포트 스캔, 매우 빈번한 로그인 실패, 네트워크를 도식화하려는 정찰 시도가 있었는지 찾는다. 공격자는 처음에 침입할 네트워크의 토폴로지를 파악한다. 이를 위해 취약한 엔드포인트와 서버를 조사하고 관리자 권한 사용자와 주요 데이터 저장소에 집중하는 것이 일반적이다.

침입 감지 프로그램 대부분이 알려진 포트 스캐너를 감지할 수 있다. 그러나 해킹을 위한 은밀한 정찰과 네트워크 브로드캐스팅에 사용되는 합법적 스캐닝을 구분하기란 쉽지 않다. 대다수 컴퓨터와 애플리케이션은 통신을 많이 하지만 네트워크에 접근하는 다양한 장치의 도착지와 포트의 수를 보면 공격 신호인 이상 동작(Anomalies)을 파악할 수 있다.

- 확인해야 할 소스 데이터: 네트워크 모니터링 및 관리 도구, 넷플로우(NetFlow)
- 남겨진 문제점: 공격자가 은밀하고 서서히 공격할 수도 있다. 따라서 어느 정도는 시간에 기반을 둔 분석이 필요하다. 또 통신이 많은 도구와 프로토콜 종류가 다양하다면, 노이즈(Noise)를 구분하기 위해 시간을 투자할 필요가 있다.

2. '정상적인(Normal) 사용자의 관리 작업을 파악한다
공격자가 안티바이러스와 EDR(Endpoint Detection and Response) 소프트웨어의 감지를 피하기 위해 알려진 공격 도구와 악성코드 대신 컴퓨터와 서버에 네이티브(독자적인) 툴을 사용하는 사례가 늘고 있다. 그러나 이 또한 파악할 수 있는 이상 동작이다.

핵심은 관리자, 즉 정상 사용자를 명확히 하는 것이다. 먼저 액티브 디렉터리(Active Directory) 같은 디렉터리 서비스는 조직 내 사용자의 역할과 권한을 지정할 때 유용하다. 또한, 관리자가 이용하는 도구나 전사자원관리(ERP) 데이터베이스와 인트라넷 웹사이트 등 통상적으로 관리하는 애플리케이션과 장치를 파악한다. 이런 정보를 정상 사용자로 보고 네트워크 활동을 분석하면 공격자가 침투한 시기와 비정상적인 관리 작업을 구별해 낼 수 있다.

- 확인해야 할 소스 데이터: 관리자 권한 동작을 파악하는 가장 좋은 방법은 네트워크 정보(네트워크 패킷 또는 넷플로우 데이터)와 디렉터리 서비스 정보를 함께 이용하는 것이다.
- 남겨진 문제점: 불행하게도 관리자와 관리자가 관리하는 자산 전체를 한번에 보여주는 단일 정보 소스는 없다. 일단은 경로와 관련해 SSH와 RPC 이용 상태를 모니터링 하는 것이 좋은 출발점이다. 긍정 오류(false positive)가 자주 발생하는 것이 단점이지만, 경험이 쌓이면 승인된 관리자로 범위를 좁힐 수 있고 이를 토대로 비정상적 활동을 감지하는 기준을 만들 수 있다.

3. 여러 계정과 크리덴셜을 이용하는 장치를 찾는다
공격자는 자신의 프로세스를 쉽게 만들고, 감지를 피하기 위해 크리덴셜을 즐겨 사용한다. 계정을 훔치거나 새로 만든 후 이를 악용해 접근 권한을 얻는 식이다. 이런 상황에서는 내부 공격자와 외부 공격자 모두를 잡아내야 하는데, 크리덴셜 이용 상태를 분석하면 이와 관련된 이상 동작을 파악할 수 있다.

- 확인해야 할 소스 데이터: 크리덴셜 악용을 파악하는 가장 좋은 리소스는 자신의 인증 권한이나 인증 인프라에서 네트워크 트래픽을 모니터하고 로그를 분석하는 것이다. 이를 통해 사용자가 평균적으로 상호작용하는 시스템 수를 확인한 후 이를 기준으로 넘어서는 동작을 감시하면 된다.
- 남겨진 문제점: 사용자마다 변수가 많다. 그러나 평균 사용자 기준을 파악하려 더 노력해야 한다. 활동이 많은 사용자를 리스트로 정리하기만 해도 상당한 가시성을 확보할 수 있다. 리스트에서 새 이름을 봤을 때 낯선 활동이란 것을 바로 확인할 수 있기 때문이다.

4. 파일 서버에서 핵심 서버를 찾으려 시도하고 있는지 확인한다
공격자가 이용하는 단계적 방법의 하나는 지적 재산이나 신용카드 번호 등 민감한 데이터를 빼내는 것이다. 혹은 데이터를 암호화하는 랜섬 공격을 위해 광범위하게 접근할 수 있는 윈도우 파일 공유 툴을 찾는 것이다. 따라서 파일 공유 관련 의심스러운 접속는 이런 공격을 탐지하는 가장 중요한 신호다. 정보 유출을 시도하는 내부자를 감지할 때도 유용하다.

- 확인해야 할 소스 데이터: 이에 대처하는 최상의 방법은 파일 서버 로그를 들여다보는 것이다. 사용자 수준에서 파악하려면 어느 정도 분석이 필요하지만, 사용자 접근 이상 동작을 확인하기에 가장 좋은 접근법이다.
- 남겨진 문제점: 매우 빈번하게 접속하는 파일 공유가 많아, 특정 사용자의 많은 접속이 처음에는 긍정 오류를 초래할 수 있다. 또 이러한 접근 데이터가 체계적이지 않고 분석하기 어렵다. 네트워크 도구에서도 확인할 수 있지만 여기서 중요한 정보를 추출하려면 상당한 노력이 필요하다.

5. C&C(Command and Control) 활동이나 지속 접근 메커니즘을 찾는다
공격자는 자신의 장악한 엔드포인트에서 외부와 통신하는 방법을 찾아야 한다. 대표적인 것이 악성코드이다. 과거보다 많이 줄었다고 하지만 이런 악성코드와 RAT(Remote Access Trojans)가 활동할 가능성은 여전하다. 따라서 아웃바운드 통신을 눈여겨 보면서 악성 코드의 활동이 있는지 판단해야 한다.

- 확인해야 할 소스 데이터: 지속적으로 C&C 활동을 조사하는 경계 보안 툴이 많이 있다. 이런 악성코드는 AWS, 애저(Azure)와 통신을 시도하거나 기존의 위협 정보(지능) 서비스가 인식하지 못하는 새로운 서버와 통신을 시도하는 것이 일반적이다.

DNS 로그에서 악성코드의 C&C 서버 탐색을 알려주는 DNS 조사 패턴이 있는지 확인해 기존 보안 체계를 보강할 수 있다. DNS 요청이 많이 실패했거나 머신이 생성한 것으로 보이는 도메인 이름 등은 평판 기반 차단 방식의 보안 제품을 피하는 악성코드가 있다는 신호다.

- 남겨진 문제점: 공격자는 다양한 방법으로 C&C 트래픽을 숨기므로 주의를 기울여야 한다. 더불어 악성코드 탐지에 특화된 툴에만 의존해서도 안 된다. 악성코드는 트위터, 크레이그스리스트, 지메일 등 정상적인 인터넷 사이트를 이용해 C&C 통신을 하기도 하므로 이런 활동도 탐지해야 한다. 더 중요한 것은 수평적인 이동과 과도한 크리덴셜 사용을 추적 관리하는 것이다. 이런 것은 공격자가 숨기기에 상대적으로 더 힘들다.

공격자를 탐지하는 데 도움이 되는 툴과 절차는 많다. 동시에 공격자는 네트워크에 침입하기 위해 해야 할 일이 많다. 공격자에게 침입은 시작에 불과하다. 최소한 봇이 공격자와 통신해야 하고, 비트코인 마이닝, 클릭 사기, 스팸, 기타 악의적인 방법으로 수익을 올리는 것이 최종 목표다. 더 심각한 경우에는 초기 침입이 공격자가 데이터를 탈취하기 위해 피해자의 네트워크를 학습해 확대하기 위한 교두보에 불과한 때도 있다.

그러나 어느 쪽이든 침입과 동시에 모든 것을 잃어버리는 상황은 발생하지 않는다. 실제 피해가 일어나기 전에 공격자와 악성코드를 없앨 충분한 시간이 있는 셈이다.

이런 공격자의 활동을 포착하는 방법도 점점 다양해지고 있다. 패킷 플로우에서 적당한 메타데이터를 추출할 수 있다면 네트워크에서 직접 포착할 수 있다. 수동으로 하기보다는 자동화된 도구를 이용하는 것이 효과적이다. 자동화된 보안 솔루션은 DPI(Deep Packet Inspection)로 네트워크 트래픽을 분석, 실제 공격의 신호인 이상 동작을 파악할 수 있다.

이런 감지 단계를 자동화하고 머신 러닝으로 네트워크의 기준선 수립 프로세스를 자동화하는 솔루션을 찾으면, 신속하게 기존 보안 통제 방법을 우회하는 공격자를 찾아 막을 수 있다.

* Kasey Cross는 라이트사이버(LightCyber)의 수석 제품 관리자다. ciokr@idg.co.kr

## C&C 탐지

PT 공격에 대응하기 위해 PC가 C&C 서버와 통신하는 것을 탐지해 차단하는
솔루션들이 많던데요, 실제 유효한 통신을 구별해 차단할 수 있는 방법을 있을까요?

[보안뉴스 권 준 기자] 수많은 좀비 PC를 거느리는 봇넷의 대량 트래픽과는 달리 APT C&C 트래픽은 소량 트래픽을 이용하고, 지속적인 주소 변경과 프락시 서버 활용 등으로 기본적으로 탐지가 매우 어려워지고 있습니다. 글로벌 보안기업 등에서 C&C 통신 채널을 탐지하는 방법으로는 전 세계적으로 C&C 사이트에 대한 DB 확보와 그들 간의 상관관계를 분석하여 네트워크 통신이 발생하는 지를 확인하는 방법과 C&C 통신 채널의 트래픽의 특성정보를 학습하여 탐지하는 방법 등이 개발되어 적용되고 있습니다.

그 예로서, 좀비 PC가 공격 실행 직전의 Connection 정보들 중 Netflow 분석을 통해서 Session 내의 TCP Flag 및 Port 값의 분포(Deviation)을 파악하여 C&C와 좀비 통신과 일반 통신을 구별해 낼 수 있습니다. 즉, 일반 통신은 SYN-NOP-RST-FIN 등의 순차적인 통신 패턴을 보여주지만 C&C와 좀비의 통신은 연속된 짧은 SYN-NOP-FIN의 통신 특성을 보여주며 특정 Unknown Port를 주로 사용합니다.
[김익균 한국전자통신연구원(ikkim21@etri.re.kr)]

C&C 서버와의 통신 차단은 두 가지 알고리즘으로 진행될 수 있습니다. 하나는 알려진 C&C 서버와의 통신 차단으로 보통 각 보안회사마다 자체적이든 협력이든 Global Threat Intelligence 정보를 활용해서 차단하게 됩니다. 두 번째는 알려지지 않은 C&C 서버와의 통신 차단은 C&C 서버로 주고 받는 메시지 내 페이로드 분석을 통해 C&C라는 확증이 발견되면 차단하게 됩니다.

이때 C&C 서버와의 통신이 TCP 통신이 아니라 SSL 통신이라면 SSL Inspection이라는 기술을 활용해서 내부 통신을 열어서 확인하거나 관리되지 않는 SSL 통신은 정책적으로 미연에 차단하는 방식을 사용하기도 합니다. 이와 같은 방법으로 C&C 서버 통신과 실제 유효한 통신을 구별해서 차단합니다만, 차단보다 더 중요한 것은 감염된 엔드포인트를 최대한 빨리 탐지해서 적절한 조치를 하는 것이라고 할 수 있습니다.
[한국IBM 박형근 실장]

APT 공격은 공격자가 장기간 대상 시스템에 대한 취약한 사항을 파악한 후, 에 공격하기 때문에 방어자가 알지 못하도록 매우 긴밀하게 이루어집니다. 이로 인해 PC가 C&C 서버와 통신하는 것을 구별해 내는 것은 매우 어렵습니다. 그래서 최근에는 비정상 행위기반 방식과 빅데이터 등의 시스템을 활용하지만 이마저도 모든 공격성이 있는 통신을 구별해 내기란 어려운 실정입니다.

조금 더 시스템의 성능과 제반환경이 마련된다면 내·외부의 통신에 대한 풀 패킷을 체크해야 하지 않을까 생각합니다. 풀 패킷을 저장한 후에 1차적으로 자동화된 분석 시스템에서 검증하고, 2차적으로 특이한 파일은 분석인력이 수행하거나 C&C 및 특정 서버와 통신시 전송되는 패킷을 풀 패킷 내에서 선별하여 해당 패킷에 대한 분석이 필요하겠습니다.
[여동균 이글루시큐리티 보안관제팀장(ydk0034@naver.com)]

대부분의 솔루션이 ‘알려진’ IP 혹은 URI 기반으로 C&C 서버에 대해 통신하는 것을 차단합니다(1.1.1.2 IP가 C&C서버일 때 1.1.1.2로 접속을 차단). 그러나 일부 보안 솔루션은 기본적으로 ‘알려진’ C&C 서버와의 통신뿐만 아니라, 고객사 내부로 유입된 파일을 가상머신에서 실제로 실행해 본 후, 악성코드로 판별된 파일이 외부로 통신을 시도하는 IP까지 확인해 ‘알려지지 않은’ C&C 서버로의 통신도 탐지·차단합니다.
[장호석 투씨에스지(hsjang@tocsg.co.kr)]

비규약, 오류발생 유도, 비유효 통신을 반복 요청할 시에 통신 요청 기법과 반복의 횟수 등을 보안정책으로 차단할 수 있습니다. 다만, 통신규약을 어기고 비규약 통신을 통해 상대 시스템의 통신 버퍼에 오버플로우를 만드는 등의 방법으로 상대 시스템을 장악하는 기법은
고난이도 기법이고 흔히 쓰는 기법이 아닙니다.

최근 APT 공격의 수법은 주로 악성문서를 이용한 공격을 많이 하는 추세라고 볼 수 있습니다. 이는 고급 포맷의 문서(Rich Document)에 기묘한 방법으로 악성코드를 삽입하는 방법으로, 통신을 통해 전달된 실행코드를 포함한 문서(Rich Document)를 열었을 때 메모리 버퍼 오버플로우 등의 시스템 오류를 내어 권한을 취득하거나 실행파일을 심어두고 PC를 제어하는 방식입니다.
[소프트캠프]

APT 공격은 정교한 악성코드와 공격기술을 활용해 기업에 침투하고 눈치채지 못하게 기밀정보를 유출시킵니다. 이러한 APT 공격은 최대한 빨리 공격을 탐지하고 대응하여 피해를 확산시키지 않는 것이 중요하므로 시중에 나온 APT 솔루션을 도입하는 것을 추천합니다.
[한국산업기술보호협회 중소기업기술지킴센터]

