# Send and Receive Data from the Splunk Platform

## Introduction

### How Splunk UBA sends and receives data from the Splunk platform

Splunk User Behavior Analytics (UBA) can send data to and receive data from the Splunk platform in a variety of ways, as shown in the following figure.

![This image shows how data can be exchanged between Splunk UBA and the Splunk platform. Each method and corresponding details are provided in the table immediately following the image](./images/600px-UBA_Splunk_Integration_v1.png)

The following table provides additional details about each type of integration between Splunk UBA and Splunk Enterprise Security (ES) and Splunk Enterprise.

<table>
<tr><td>Integration</td><td>Configuration</td><td>How to Secure</td><td>Splunk Add-on for Splunk UBA Required?</td><td>Documentation</td></tr>
<tr><td>Splunk UBA pushes anomalies and threats to Splunk ES as notable events. Splunk UBA anomalies and threats are stored in Splunk ES as notable events.</td><td>Configure the SplunkES output connector in Splunk UBA and connect to port 10008 on the Splunk ES search head.</td><td>TLS (store the Splunk root CA certificate in Splunk UBA)</td><td>Yes</td><td><a href="">Send Splunk UBA anomalies and threats to Splunk ES as notable events.</a></td></tr>
<tr><td>Splunk UBA pulls notable events from Splunk ES and stores them in Splunk UBA as External Alarms.</td><td>Configure a data source connecter in Splunk UBA and connect to the search head or forwarder port 8089 on Splunk ES.</td><td>TLS (store the Splunk root CA certificate in Splunk UBA)</td><td>Yes</td><td><a href="">Pull notable events from Splunk ES to Splunk UBA.</a></td></tr>
<tr><td>Splunk UBA pushes health logs to Splunk Enterprise. Use the Splunk UBA Monitoring App to monitor the health of your Splunk UBA deployment from Splunk Enterprise.</td><td>Enable the forwarder embedded in Splunk UBA to forward health logs to the _internal index on port 9997. You can customize the index and port number as needed.</td><td>TLS (the usual ways to secure forwarder-to-indexer communications)</td><td>No</td><td><a href="">About the Splunk UBA Monitoring app</a> in the Splunk UBA Monitoring App manual.</td></tr>
<tr><td>Splunk UBA pushes audit data to Splunk Enterprise for analysis.</td><td>Configure the property in the uba-site.properties file in Splunk UBA to send audit events to Splunk search head or forwarder port 10008. Events are sent to the _audit index on Splunk Enterprise.</td><td>TLS (store the Splunk root CA certificate in Splunk UBA)</td><td>Yes</td><td><a href="">Send Splunk UBA audit events to Splunk ES.</a></td></tr>
<tr><td>Splunk Enterprise pushes events directly to Kafka on Splunk UBA.</td><td>Splunk UBA issues micro batch queries to the REST API on the Splunk search head on port 8089. The indexers then push the search results back to Kafka on Splunk UBA (port 9093).</td><td>TLS (store the Splunk root CA certificate in Splunk UBA)</td><td>No</td><td><a href="">Send data from the Splunk Platform directly to Kafka</a> in the Splunk UBA Kafka Ingestion App manual.</td></tr>
<tr><td>Splunk UBA pulls raw events from Splunk Enterprise.</td><td>Configure a Splunk connector in Splunk UBA and connect to a Splunk search head on port 8089.</td><td>TLS (secure access to Splunk's REST API)</td><td>No</td><td><a href="">Use connectors to add data from the Splunk platform to Splunk UBA in the Get Data into Splunk User Behavior Analytics manual.
<tr><td>Use Event Drilldown in Splunk UBA to view raw events in the Splunk platform.</td><td>No data is passed. Clicking on the link takes you to Splunk Enterprise, where the raw events query is run. Splunk web (8000/443) and management ports (8089).</td><td>TLS (secure access to Splunk's REST API)</td><td>No</td><td><a href="">Use event drilldown to review an anomaly's raw events in</a> Use Splunk User Behavior Analytics.</td></tr>
</table>

### About the Splunk Add-on for Splunk UBA

The Splunk Add-on for Splunk UBA indexes data sent from Splunk User Behavior Analytics (UBA) to the Splunk platform and allows you to send data from the Splunk platform to Splunk UBA. The Splunk Add-on for Splunk UBA consists of two separate add-ons:

- The SA-UEBA add-on is installed in the SA-UEBA directory and is a supporting add-on for Splunk UBA. This add-on is disabled by default. The SA-UEBA add-on has no configuration options and only needs to be enabled in your environment.
- The Splunk Add-on for UEBA is installed in the Splunk_TA_ueba directory and is a technology add-on for Splunk UBA. This add-on is enabled by default and has configuration options.

#### How do I obtain the Splunk Add-on for Splunk UBA?

The Splunk Add-on for UBA is not available for download on Splunkbase. The add-on is installed by default with Splunk Enterprise Security (ES). If you find that the Splunk Add-on for UBA is not installed, run the Splunk Enterprise Security Post-Install Configuration again and ensure that Splunk_TA_ueba is selected for installation. See Install Splunk Enterprise Security in the Splunk Enterprise Security Installation and Upgrade manual.

#### Functionality provided by the Splunk Add-on for Splunk UBA

In any environment with both Splunk UBA and Splunk ES, both add-ons included in the Splunk Add-on for Splunk UBA are required and both must be enabled.

The SA-UEBA add-on provides the following features and capabilities:

- Contains the ueba data model definition for Splunk UBA threats and anomalies which provides accelerated Splunk UBA information to Splunk ES.
- Defines the ubauser, ubadevice, ubahistory, and ubaevents macros in Splunk ES.
- Defines multiple correlation searches relating to Splunk UBA anomaly and threat detection:
    - Threat - UEBA Threat Detected (Notable) – Rule
    - Threat - UEBA Threat Detected (Risk) – Rule
    - Threat - UEBA Anomaly Detected (Risk) – Rule
- Defines multiple key-indicator searches for populating Splunk web in Splunk ES, such as anomaly actors, anomaly signatures, anomalies per threat, and total anomalies.
- Defines the UEBA - Notable External Reference - Lookup Gen lookup generation search.
- Defines multiple swim-lane searches for populating Splunk Web in Splunk ES, such as UEBA Threats By Asset, UEBA Threats By Identity, UBA Anomalies By Asset, and UBA Anomalies By Identity.

The Splunk Add-on for UEBA provides the following features and capabilities:

- Contains the send2uba function which allows saved search results to be forwarded to Splunk UBA.
- Defines the edit_uba_settings capability which is added to the ess_admin role in Splunk ES and can be assigned.
- Defines the syslog-based output for Splunk UBA data in the ubaroute index.
- Defines multiple macros used to enrich events within Splunk ES to make them compatible with Splunk UBA.
- Defines the Event Drilldown workflow. See Use event drilldown to review an anomaly's raw events in the Use Splunk User Behavior Analytics manual.
- Contains lookups that can be referenced, such as a lookup for converting a Splunk UBA threat score into a Splunk ES urgency value.
- Enables Splunk ES to retrieve user and device association data from Splunk UBA.

See the following table for a summary of the functionality provided by SA-UEBA and the Splunk Add-on for UEBA.

|Feature|SA-UEBA|Splunk Add-on for UEBA|
|:--:|:--:|:--|
|Visible?|No|Yes, this add-on contains a view for configuration.|
|Collection method|TCP|TCP port 10008|
|CIM Compliance|None|None. This data maps to the UEBA data model included with Splunk ES. See Data models used by ES in the Developer Guide for Splunk Cloud and Splunk Enterprise.|
|Sourcetypes|uba_audit|ueba, stash_uba|
|Indexes|N/A|ueba, ubaroute|

## Deploy the Splunk Add-on for Splunk UBA


Requirements for using the Splunk Add-on for Splunk UBA
Before integrating Splunk User Behavior Analytics (UBA) with Splunk Enterprise or Splunk Enterprise Security (ES), meet these requirements:

Verify that you are using compatible versions of Splunk UBA, Splunk Enterprise, and Splunk ES. See Compatible software versions.
Verify that you have properly configured Splunk UBA, Splunk Enterprise, and Splunk ES for integration. See Splunk Enterprise and Splunk ES requirements.
Verify that you have properly configured authentication for Splunk ES users to access Splunk UBA. See Configure authentication between Splunk UBA and Splunk ES.
Splunk Cloud customers must contact Splunk Support to fully integrate with Splunk UBA. The Splunk Cloud sc_admin role cannot perform Splunk UBA setup.

Compatible software versions
Verify the version compatibility among the products in the table.

Splunk Add-on for Splunk UBA	Splunk Enterprise Security	Splunk UBA
2.0.0	5.x, 6.0.1, 6.0.2	4.2.x, 4.3.x
3.0.0	6.1.0 and higher	5.x
3.1.0	6.3.0 and higher	5.x
See the Splunk products version compatibility matrix in the Splunk Products Version Compatibility Matrix manual for more information about compatibility among Splunk products.

Splunk Enterprise and Splunk ES requirements
Meet the following requirements to integrate Splunk UBA with Splunk Enterprise and Splunk ES.

Verify that you have a Splunk Enterprise user account that meets all the requirements listed in Requirements for the Splunk Enterprise user account in the Install and Upgrade Splunk User Behavior Analytics manual.
Verify that the Splunk Add-on for Splunk UBA is installed and enabled on your search head with the ueba index deployed to your indexers. See Deploy the Splunk Add-on for Splunk UBA.
Verify that the name of the Splunk UBA server is specified correctly in Splunk ES. The name of the Splunk UBA server that you specified when running the /opt/caspida/bin/Caspida setup command during Splunk UBA installation must match the value stored in the uiServer.host property in the /etc/caspida/local/conf/uba-site.properties file in Splunk UBA. The name of the Splunk UBA server that was specified during setup is stored in the /opt/caspida/conf/deployment/caspida-deployment.conf file.
If you specified a Splunk UBA host name such as ubahost1 during setup, make sure that uiServer.host is set to the same host name.
If you specified an IP address such as 10.11.12.1 during setup, make sure that uiServer.host is set to the same IP address.
Configure an output connector on Splunk UBA to send anomalies and threats from Splunk UBA to Splunk ES. During this configuration, you must provide a username and password for a Splunk ES account with at least the permissions granted by the ess_analyst role with edit_reviewstatuses capability so that Splunk UBA is fully authorized for this integration. This privilege level is required so that Splunk UBA can access the Splunk ES APIs and make changes to the status of notable events. See Add an output connector in Splunk UBA.
Configure authentication between Splunk UBA and Splunk ES
Starting with release 6.1.0, Splunk ES can use a local user account to integrate with Splunk UBA. To perform the integration, meet the following requirements:

In Splunk UBA, configure an account with the name of ubaesuser and the role of User. See Add a local user account in the Administer Splunk User Behavior Analytics manual.
In Splunk ES, create the matching credentials. See Add a new credential for UBA input in the Splunk Enterprise Security Administer Splunk Enterprise Security manual.
If you are using a Splunk ES release earlier than 6.1.0, configure Splunk authentication in Splunk UBA to integrate Splunk UBA and Splunk ES. See Configure Splunk authentication using Splunk UBA in the Administer Splunk User Behavior Analytics manual.

Deploy the Splunk Add-on for Splunk UBA
Determine where and how to install this add-on in your distributed deployment using the information on this page.

Where to install this add-on
Depending on your environment, your preferences, and the requirements of the add-on, you might need to install the add-on in multiple places.

To deploy it alongside Splunk Enterprise Security, see Deploy add-ons to Splunk Enterprise Security in the Splunk Enterprise Security Installation and Upgrade Manual.

Splunk instance type	Supported	Required	Comments
Search Heads	Yes	Yes	This add-on is installed on the search head when you install Enterprise Security.
Indexers	Yes	Yes	This add-on includes two indexes and index-time configurations.
Heavy Forwarders	Yes	No	All forwarder types are supported.
Universal Forwarders	Yes	No	All forwarder types are supported.
Distributed deployment feature compatibility
This table describes the compatibility of this add-on with Splunk distributed deployment features.

Distributed deployment feature	Supported	Details
Search Head Clusters	Yes	Changes made during setup must be manually deployed.
Indexer Clusters	Yes	This add-on contains indexes.
Deployment Server	Yes	Supported for deploying the configured add-on to multiple nodes.



## Use the Splunk Add-on for Splunk UBA to send and receive data from Splunk ES

Integrate Splunk ES and Splunk UBA with the Splunk Add-on for Splunk UBA
Use the Splunk Add-on for Splunk UBA to integrate Splunk Enterprise Security (ES) and Splunk User Behavior Analytics (UBA). You can integrate Splunk UBA and Splunk ES to share the following types of data:

Send Splunk UBA anomalies and threats to Splunk ES as notable events.
Pull notable events from Splunk ES to Splunk UBA.
Send Splunk UBA audit events to Splunk ES.
See Viewing data from Splunk UBA in Enterprise Security in Use Splunk Enterprise Security for more information.

Use Splunk ES to close or reopen notable events in order to have the corresponding threats also be closed or reopened in Splunk UBA. Do not close or reopen threats in Splunk UBA.

For instructions on how to send events from Splunk UBA to Splunk Enterprise without using Splunk ES, see Send Splunk UBA data to Splunk Enterprise without Splunk Enterprise Security in Administer Splunk User Behavior Analytics.

Send Splunk UBA anomalies and threats to Splunk ES as notable events
This image summarizes the steps you need to take to push anomalies and threats from Splunk User Behavior Analytics (UBA) to Splunk Enterprise Security (ES) as notable events.

This image shows the steps for how to send anomalies and threats from Splunk UBA to Splunk ES. The steps in the image are described immediately following the image.

Verify that the Splunk Add-on for UEBA is installed and enabled.
Enable SA-UEBA so that Splunk ES can retrieve data from Splunk UBA.
Configure the Splunk platform to receive data from the Splunk UBA output connector.
Add an output connector in Splunk UBA.
(Optional) Learn How threats and notables are synchronized.
Verify that the Splunk Add-on for UEBA is installed and enabled
Perform the following steps to verify that the Splunk Add-on for UEBA is installed.

Log in to the Splunk search head with Splunk Enterprise Security installed.
In Splunk Web, select Apps > Manage Apps.
Search for ueba and verify that Splunk_TA_ueba is installed and enabled.
If the add-on is not enabled, click Enable to enable it.
Enable SA-UEBA so that Splunk ES can retrieve data from Splunk UBA
Enable SA-UEBA so that dashboards and knowledge objects are visible to users in Splunk Enterprise Security. This task is required to retrieve data from Splunk UBA to display on the Session Center dashboard in Splunk Enterprise Security, to model data sent from Splunk UBA with the UEBA data model, and to use correlation searches to analyze threats and anomalies sent from Splunk UBA.

Log in to the Splunk search head with Splunk Enterprise Security installed.
In Splunk Web, select Apps > Manage Apps.
Locate the SA-UEBA add-on.
Click Enable to enable the add-on.
Configure the Splunk platform to receive data from the Splunk UBA output connector
The connection between Splunk UBA and the Splunk platform uses TCP-SSL by default. Set up the Splunk platform to accept the encrypted connection so that the Splunk platform can receive data from the Splunk UBA output connector.

Splunk Cloud customers must work with Splunk Cloud Support to set up this connection.

The following procedure uses the Splunk default certificates and the global [SSL] stanza in the inputs.conf file. For better security, consider using your own certificates, or commercially signed certificates from a trusted certificate authority.

See About securing Splunk Enterprise with SSL in the Splunk Enterprise Securing the Splunk Platform manual.
See TCP: in the Splunk Enterprise Admin Manual for more information about configuring tcp-ssl using inputs.conf.
Perform the following steps on Splunk Enterprise:

Create a local folder under $SPLUNK_HOME/etc/apps/Splunk_TA_ueba. For example:
cd /opt/splunk/etc/apps/Splunk_TA_ueba
mkdir local
Create a file called inputs.conf and add two stanzas to match the following:
[tcp-ssl:10008]
listenOnIPv6 = no
index = ueba
sourcetype = ueba

[SSL]
serverCert = $SPLUNK_HOME/etc/auth/server.pem
sslPassword = password
In distributed deployments, deploy the changes to the inputs.conf file across all peers in your indexer cluster. See Manage common configurations across all peers in the Splunk Enterprise Managing Indexers and Clusters of Indexers manual.
Restart Splunk Enterprise.
In Splunk Web, select System > Server controls.
Click Restart Splunk.
Verify that SSL is enabled for port 10008 in $SPLUNK_HOME/var/log/splunk/splunkd.log. For example:
11-07-2019 15:07:42.661 -0800 INFO  TcpInputProc - Creating raw Acceptor for IPv4 port 10008 with SSL
Copy the root CA certificate from /opt/splunk/etc/auth/cacert.pem on the Splunk Enterprise instance to /home/caspida on the Splunk UBA management server.
Perform the following tasks on the Splunk UBA management server:

Log in to the Splunk UBA management server as the caspida user.
Ensure that $JAVA_HOME is set correctly on your system. Run the CaspidaCommonEnv.sh script to set this environment variable:
. /opt/caspida/bin/CaspidaCommonEnv.sh
Import the rootCA certificate to the Java certificate store.
On CentOS systems, use the following command:
sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/lib/security/cacerts -file ~/cacert.pem
On other Linux systems, use the following command:

sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/jre/lib/security/cacerts -file ~/cacert.pem
When prompted, type the keystore password and trust the certificate. The default keystore password is changeit.
Restart Splunk UBA. Run the following commands on the Splunk UBA management server:
/opt/caspida/bin/Caspida stop-all
/opt/caspida/bin/Caspida start-all
Add an output connector in Splunk UBA
Set up Splunk UBA to send data to the Splunk search head or a Splunk forwarder. Splunk UBA uses the output connector to send anomalies and threats to Splunk Enterprise Security.

Make sure the Splunk Add-on for Splunk UBA is properly deployed and enabled. See Deploy the Splunk Add-on for Splunk UBA.
Make sure the SA-UEBA add-on is enabled. See Enable SA-UEBA so that Splunk ES can retrieve data from Splunk UBA.
Log in to Splunk UBA as an admin user.
Select Manage > Output Connectors.
Click New Output Connector.
Select an output connector of SplunkES and click Next.
Type a Name for the output connector.
The Forwarder Host is the IP address of the Splunk search head or forwarder with the TCP data input enabled. For a search head cluster, choose a search head to integrate with Splunk UBA because Splunk UBA does not support integrating with multiple search heads.
The Forwarder Port is TCP port 10008 that is open for receiving data on the Splunk search head or forwarder. Make sure this port is open behind your firewall.
Specify the Splunk ES API URL in the following format:
https://<forwarder-host>:<mgmt-port>
Splunk UBA uses this connection to synchronize the status of its threats with notable events in Splunk ES. The management port is usually 8089.
Specify a username and password. See Splunk Enterprise and Splunk ES requirements for the requirements of this user account.
Select how you want this output connector to process anomalies and threats.
Option	Description
Process Threats	Select Process Threats to enable Splunk UBA to export threats based on any configured output connectors, such as sending email or sending threats to Splunk ES. If this is not selected, no threats are exported from Splunk UBA, even if Auto Process is selected.
Process Anomalies	Select Process Anomalies to enable Splunk UBA to export anomalies based on any configured output connectors, such as sending email or sending anomalies to Splunk ES. If this is not selected, no anomalies are exported from Splunk UBA, even if Auto Process is selected.
Auto Process	Select Auto Process to automatically forward anomalies and threats as they are created to Splunk ES. If this is not selected, you must forward each anomaly or threat individually during threat review with the Export to Splunk ES action from the Anomaly Details or Threat Details page. See Review Current Threats in Use Splunk User Behavior Analytics.

Selecting Auto Process in conjunction with Process Anomalies can cause a significant increase in traffic. Review the output connector logs to verify the health and performance of your system. See the Output Connector Service health monitor status codes. If you are monitoring Splunk UBA using the Splunk UBA Monitoring app, see About the Splunk UBA Monitoring app in theSplunk UBA Monitoring App manual.

Click OK to save the new output connector.
If the output connector does not work, verify that you configured the host server correctly in the uba-site.properties file. The host identified in the file populates the host field for events sent to Splunk Enterprise Security or the Splunk platform. See Connect Splunk UBA to Splunk Enterprise to view an anomaly's raw events in Install and Upgrade Splunk User Behavior Analytics.

How threats and notable events are synchronized
Once the output connector is configured, Splunk UBA attempts to send threats to Splunk ES every 5 minutes with no limits on the number of retries. Any issues with the connection mean that new threats are not sent to Splunk ES until the connection issues are resolved. Any connection issues between the output connector and Splunk ES also affect other output connectors that are configured, such as email and ServiceNow. If the connection issues persist for more than one hour, alerts are generated in the health monitor in Splunk UBA. See Monitor the health of your Splunk UBA deployment in Administer Splunk User Behavior Analytics.

Perform the following steps to change the retry interval:

On the Splunk UBA management node, log in as the caspida user.
Edit the etc/caspida/local/conf/uba-site.properties file and modify the uba.splunkes.retry.delay.minutes property. For example, to set the retry interval to 3 mintues:
uba.splunkes.retry.delay.minutes = 3
In distributed deployments, synchronize the cluster:
/opt/caspida/bin/Caspida sync-cluster  /etc/caspida/local/conf
Work with Splunk UBA threats as notable events in Splunk ES
When Splunk UBA and Splunk ES are integrated using an output connector, Splunk UBA creates a new custom status on Splunk ES called Closed in Uba as shown in the following image.

This screen image shows the Status Configuration page in Splunk ES with a list of available statuses for notable events. The status with the label Closed in Uba is highlighted.

The status of threats in Splunk UBA and their corresponding notable events in Splunk ES are synchronized.

What happens when a threat is closed in Splunk UBA
Threats in Splunk UBA can be closed by the user or closed by the system:

Threats in Splunk UBA are considered closed by the user if a user clicks Not a Threat in Splunk UBA.
In all other cases, the threat in Splunk UBA is considered to be closed by the system.
When a threat is closed in Splunk UBA, Splunk UBA checks the status of the corresponding notable event in Splunk ES. If the notable event is not already closed in Splunk ES, Splunk UBA closes the notable event by setting the end status to Closed in Uba.

If the notable event is reopened in Splunk ES, a threat closed by the user in Splunk UBA is reopened. A threat closed by the system remains closed in Splunk UBA. The threat can still be viewed, but no action can be taken on the threat. This workflow is illustrated in the following diagram:

This screen image shows a flowchart of threats in Splunk UBA and their corresponding notable events in Splunk Enterprise Security. The flow of the data is described in the surrounding text.

What happens when a threat is reopened in Splunk UBA
A threat in Splunk UBA can be reopened in the following cases:

Threat computation causes a threat to be reopened.
An anomaly action rule affects anomalies that cause a threat to be reopened.
A threat rule is modified, causing a threat to be reopened.
When a threat is reopened, Splunk UBA checks to see if the notable event in Splunk ES has an end status of ClosedInUba and if yes, the notable event is also reopened.

No action is taken if the notable event is already open in Splunk ES, or if it has an end status other than ClosedInUba.

Splunk UBA queries for the status of notable events in Splunk ES
Splunk UBA queries Splunk ES in 5-minute intervals to synchronize the status of threats in Splunk UBA and notable events in Splunk ES.

When the query detects that a notable event is closed, Splunk UBA checks to see if the corresponding threat is also closed. If not, the threat is closed with a status of ClosedbyUser as shown in the following diagram:

This flowchart shows what happens to a threat in Splunk UBA when the status of its notable event is closed. If the threat is already closed in Splunk UBA, then no action is taken. If the threat is still active in Splunk UBA, then it is closed with a status of ClosedByUser.

When the query detects that a notable event is not closed, Splunk UBA checks to see if the corresponding threat has a status of ClosedbyUser. If so, the threat is reopened with a status of Active as shown in the following diagram:

This flowchart shows what happens to a threat in Splunk UBA when the status of its notable event is not closed. If the threat does not have a status of ClosedByUser in Splunk UBA, then no action is taken. If the threat has a status of ClosedByUser in Splunk UBA, then it is reopened with a status of Active.

What happens if the output connector is unable to send threats to Splunk ES?
If the output connector is unable to send threats to Splunk ES, due to a network issue or Splunk ES being temporarily unavailable, the output connector makes another attempt every 5 minutes. After 1 hour, if the connection is not resolved, the output connector raises an error in the health monitor. See OCS-11 in Administer Splunk User Behavior Analytics.


Pull notable events from Splunk ES to Splunk UBA
This image summarizes the steps you need to take to configure a Splunk ES Notables or Splunk Direct data source to pull notable events from Splunk Enterprise Security (ES) to Splunk User Behavior Analytics (UBA).

This image shows the steps for how to pull notable events from Splunk ES to Splunk UBA. The steps in the image are described immediately following the image.

Perform the following tasks to set up the desired data source in Splunk UBA:

In Splunk ES, Set up Splunk UBA to receive notable events from Splunk ES.
In both Splunk Enterprise and Splunk UBA, Configure the Splunk platform to receive data from the Splunk UBA output connector.
Set up Splunk UBA to pull notable events from Splunk ES. See Send notable events to Splunk UBA.
Set up Splunk UBA to receive notable events from Splunk ES
In Splunk ES, perform the following tasks so that Splunk UBA can receive notable events from Splunk ES:

Splunk Cloud customers must contact Splunk Support to perform the Splunk UBA setup.

From the Splunk ES menu bar, select Configure > UBA Setup. You can also select Apps > Manage Apps and select Set up next to this add-on.
In the Management Server field, type the host name and port number of the Splunk ES output connector on the Splunk UBA management server using port 10008. For example, <server IP address>:10008.
In the Type field, select whether to use the TCP or UDP protocol to send the correlation search results to Splunk UBA.
Configure the Splunk platform to receive data from the Splunk UBA output connector
The connection between Splunk UBA and the Splunk platform uses TCP-SSL by default. Set up the Splunk platform to accept the encrypted connection so that the Splunk platform can receive data from the Splunk UBA output connector.

Splunk Cloud customers must work with Splunk Cloud Support to set up this connection.

The following procedure uses the Splunk default certificates and the global [SSL] stanza in the inputs.conf file. For better security, consider using your own certificates, or commercially signed certificates from a trusted certificate authority.

See About securing Splunk Enterprise with SSL in the Splunk Enterprise Securing the Splunk Platform manual.
See TCP: in the Splunk Enterprise Admin Manual for more information about configuring tcp-ssl using inputs.conf.
Perform the following steps on Splunk Enterprise:

Create a local folder under $SPLUNK_HOME/etc/apps/Splunk_TA_ueba. For example:
cd /opt/splunk/etc/apps/Splunk_TA_ueba
mkdir local
Create a file called inputs.conf and add two stanzas to match the following:
[tcp-ssl:10008]
listenOnIPv6 = no
index = ueba
sourcetype = ueba

[SSL]
serverCert = $SPLUNK_HOME/etc/auth/server.pem
sslPassword = password
In distributed deployments, deploy the changes to the inputs.conf file across all peers in your indexer cluster. See Manage common configurations across all peers in the Splunk Enterprise Managing Indexers and Clusters of Indexers manual.
Restart Splunk Enterprise.
In Splunk Web, select System > Server controls.
Click Restart Splunk.
Verify that SSL is enabled for port 10008 in $SPLUNK_HOME/var/log/splunk/splunkd.log. For example:
11-07-2019 15:07:42.661 -0800 INFO  TcpInputProc - Creating raw Acceptor for IPv4 port 10008 with SSL
Copy the root CA certificate from /opt/splunk/etc/auth/cacert.pem on the Splunk Enterprise instance to /home/caspida on the Splunk UBA management server.
Perform the following tasks on the Splunk UBA management server:

Log in to the Splunk UBA management server as the caspida user.
Ensure that $JAVA_HOME is set correctly on your system. Run the CaspidaCommonEnv.sh script to set this environment variable:
. /opt/caspida/bin/CaspidaCommonEnv.sh
Import the rootCA certificate to the Java certificate store.
On CentOS systems, use the following command:
sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/lib/security/cacerts -file ~/cacert.pem
On other Linux systems, use the following command:

sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/jre/lib/security/cacerts -file ~/cacert.pem
When prompted, type the keystore password and trust the certificate. The default keystore password is changeit.
Restart Splunk UBA. Run the following commands on the Splunk UBA management server:
/opt/caspida/bin/Caspida stop-all
/opt/caspida/bin/Caspida start-all
Send notable events to Splunk UBA
Use one of the following methods to send notable events from Splunk ES to Splunk UBA:

Send notable events and risk events using the Splunk ES Notables data source
Send notable events using Splunk Direct
Send notable events and risk events using the Splunk ES Notables data source
Use the Splunk ES Notables data source in Splunk UBA to integrate Splunk UBA with Splunk ES. Configure Splunk UBA to connect to the Splunk ES search head. The Splunk ES Notables data source automatically ingests notable events and risk events from Splunk ES and properly maps categories from Splunk ES Content Updates. If you have custom correlation searches in Splunk ES, make sure the category field is added correctly in the correlation search.

See Filter the anomaly table in Use Splunk User Behavior Analytics to view the list of anomaly categories. The category field must match one of the listed categories. The Splunk UBA external alarm model uses these events and category mappings to generate meaningful anomalies which can subsequently raise the appropriate threats.

Notable events that are closed in Splunk ES are not ingested by Splunk UBA.

In Splunk UBA, select Manage > Data Sources.
Click New Data Source.
In the SIEM Connectors category, click Splunk ES Notables.
On the Connection screen, provide connection and authentication details to connect to Splunk ES, then click Next. The user credentials must have permissions to access the notable events and risk indexes.
On the Time Range screen, select Live and All Time, then click Next.
On the Splunk Query screen, verify the SPL being used to retrieve the events and category mappings from Splunk ES, then click Next. If you need to modify the SPL, make sure NOT (source="UEBA" OR source="UBA") is included in the final SPL to exclude Splunk UBA anomalies and threats.
On the Test Mode screen, click Test Mode to validate the data source before ingesting all events, then click Next. See Add data sources to Splunk UBA in test mode for more information about test mode.
Click OK.
Send notable events using Splunk Direct
Use Splunk Direct to send notable events from Splunk ES to Splunk UBA by configuring an external alarm data source. Write a custom query to handle the necessary data enrichment such as mapping the alarm category or severity.

In Splunk ES, confirm that you get the desired notable events from the following query. The query analyzes notable events on Splunk ES that are not generated from Splunk UBA data sources and performs the proper mappings for the External Alarm category on Splunk UBA.
You will need this query in the following steps.

`notable`
| search NOT (source="*UEBA*" OR source="*UBA*")
| eval action=IF(action="deferred" OR action="blocked","blocked","allowed")
| eval tag="attack,network,communicate", app='Authentication.app', dest_zone='dest_pci_domain', 
  src_host='src_nt_host', src_zone='src_pci_domain'
| eval severity="Critical",evcls=coalesce(signature,savedsearch_name,search_name)
| eval signature=IF(isnull(signature),evcls,signature)
| eval alarmCategories=CASE(
  like(lower(evcls),"%application%") OR like(lower(evcls),"%vulnerability%"),"ProductAttack",
  like(lower(evcls),"%intrusion%"),"SystemAttack",
  like(lower(evcls),"%data%loss%") OR like(lower(evcls),"%dlp%") 
    OR like(lower(evcls),"%dlp%") OR like(lower(evcls),"%exfil%"),"Exfiltration",
  like(lower(evcls),"%malware%") OR like(lower(evcls),"%virus%") 
    OR like(lower(evcls),"%botnet%") OR like(lower(evcls),"%backdoor%") 
    OR like(lower(evcls),"%trojan%"),"MalwarePersistence",
  like(lower(evcls),"%malware%_operations") OR like(lower(evcls),"%cnc%") 
    OR like(lower(evcls),"%callback%"),"MalwareActivity",
  like(lower(evcls),"%spam%") 
    OR like(lower(evcls),"%phish%"),"MalwareInstall",1=1,"PolicyViolation")
| eval user=IF(isnull(user) AND like(dest,"%@%"),dest,user), 
  dest_ip=coalesce(dest_ip,'values(dest)'),eventtype=evcls,
  user=IF(like(user,"%wireless%"),"",user), src_ip=IF(isnull(src_ip) 
    AND NOT like(src,"%@%"), src,src_ip), dest_ip=IF( like(dest_ip,"%@%"),'',dest_ip)
| makemv delim="," tag
| makemv delim=" " dest_ip
| mvexpand dest_ip
| fields action,alarmCategories,app,category,dest_host,dest_ip,dest_nt_domain,
  dest_zone,duration,eventtype,file_name,file_path,severity,signature,
  sourcetype,src_host,src_ip,src_zone,tag,url,user

In Splunk UBA, select Manage > Data Sources.
Click New Data Source.
Under SIEM Connectors, select Splunk.
Specify the connection details to Splunk ES. Select Splunk Direct as the connector type and specify the SSL management port for your Splunk ES instance.
Select Live and All Time as the date range.
In the Splunk Query field, specify the query that you verified at the beginning of this procedure.
On the Data Format page, select External Alarm as the field category. Keep the default values in the Splunk Field column.
Enter the query that you verified at the beginning of this procedure again.
Make sure Test Mode is not selected, and then click OK.

Use the legacy Netcat data source to push notable events from Splunk ES to Splunk UBA
Perform the following tasks to send correlation search results from Splunk Enterprise Security (ES) to Splunk User Behavior Analytics (UBA) to be processed for anomalies.

Set up Splunk UBA to receive notable events from Splunk ES.
Configure the SPlunk platform to receive data form the Splunk UBA output connector.
Set up correlation search results as a data source in Splunk UBA.
Send notable events to Splunk UBA.
Set up Splunk UBA to receive notable events from Splunk ES
In Splunk ES, perform the following tasks so that Splunk UBA can receive notable events from Splunk ES:

Splunk Cloud customers must contact Splunk Support to perform the Splunk UBA setup.

From the Splunk ES menu bar, select Configure > UBA Setup. You can also select Apps > Manage Apps and select Set up next to this add-on.
In the Management Server field, type the host name and port number of the Splunk ES output connector on the Splunk UBA management server using port 10008. For example, <server IP address>:10008.
In the Type field, select whether to use the TCP or UDP protocol to send the correlation search results to Splunk UBA.
Configure the Splunk platform to receive data from the Splunk UBA output connector
The connection between Splunk UBA and the Splunk platform uses TCP-SSL by default. Set up the Splunk platform to accept the encrypted connection so that the Splunk platform can receive data from the Splunk UBA output connector.

Splunk Cloud customers must work with Splunk Cloud Support to set up this connection.

The following procedure uses the Splunk default certificates and the global [SSL] stanza in the inputs.conf file. For better security, consider using your own certificates, or commercially signed certificates from a trusted certificate authority.

See About securing Splunk Enterprise with SSL in the Splunk Enterprise Securing the Splunk Platform manual.
See TCP: in the Splunk Enterprise Admin Manual for more information about configuring tcp-ssl using inputs.conf.
Perform the following steps on Splunk Enterprise:

Create a local folder under $SPLUNK_HOME/etc/apps/Splunk_TA_ueba. For example:
cd /opt/splunk/etc/apps/Splunk_TA_ueba
mkdir local
Create a file called inputs.conf and add two stanzas to match the following:
[tcp-ssl:10008]
listenOnIPv6 = no
index = ueba
sourcetype = ueba

[SSL]
serverCert = $SPLUNK_HOME/etc/auth/server.pem
sslPassword = password
In distributed deployments, deploy the changes to the inputs.conf file across all peers in your indexer cluster. See Manage common configurations across all peers in the Splunk Enterprise Managing Indexers and Clusters of Indexers manual.
Restart Splunk Enterprise.
In Splunk Web, select System > Server controls.
Click Restart Splunk.
Verify that SSL is enabled for port 10008 in $SPLUNK_HOME/var/log/splunk/splunkd.log. For example:
11-07-2019 15:07:42.661 -0800 INFO  TcpInputProc - Creating raw Acceptor for IPv4 port 10008 with SSL
Copy the root CA certificate from /opt/splunk/etc/auth/cacert.pem on the Splunk Enterprise instance to /home/caspida on the Splunk UBA management server.
Perform the following tasks on the Splunk UBA management server:

Log in to the Splunk UBA management server as the caspida user.
Ensure that $JAVA_HOME is set correctly on your system. Run the CaspidaCommonEnv.sh script to set this environment variable:
. /opt/caspida/bin/CaspidaCommonEnv.sh
Import the rootCA certificate to the Java certificate store.
On CentOS systems, use the following command:
sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/lib/security/cacerts -file ~/cacert.pem
On other Linux systems, use the following command:

sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/jre/lib/security/cacerts -file ~/cacert.pem
When prompted, type the keystore password and trust the certificate. The default keystore password is changeit.
Restart Splunk UBA. Run the following commands on the Splunk UBA management server:
/opt/caspida/bin/Caspida stop-all
/opt/caspida/bin/Caspida start-all
Set up correlation search results as a data source in Splunk UBA
Set up a new data source in Splunk UBA to receive correlation search results from Splunk ES.

Perform the following steps in Splunk UBA:

Select Config > Data Sources and click New Data Source.
Select a data source of Netcat.
Specify a name for the data source, such as ESnotables. The data source name must be alphanumeric, with no spaces or special characters.
Select a format of SplunkES Correlation Search.
Click Next.
Deselect the check box for Test Mode.
Click OK to save the new data source.
Click the data source after it is created, and make a note of the URL, including the port number. Port 10000 is used the first time you create a Netcat data source. Each additional Netcat data source increments the port number by 1, including if you delete a Netcat data source and then re-create the same data source later. The port number is required to send content from Splunk ES to Splunk UBA. If you are adding multiple data sources, or testing and adding the same data source multiple times, keep track of the port number assigned to the data sources you want to use.

The following image shows a data source named ESNotables after it is configured in Splunk UBA:

This screen image shows the details of a Data Source in Splunk UBA. The page shows several widgets, in particular one named "URL" with the IP address of 192.168.0.132:10000.

Perform the following tasks in Splunk ES:

Select Configure > UBA Setup.
Enter the IP address and port number of the data source in the Management Server field. This value must match the IP address and port number shown in the data source you created. Note that you do not need to provide the https:// portion of the URL.
Restart the Splunk platform.
This screen image shows the UBA Setup page in Splunk ES. The "Management Server" field contains the IP address of 192.168.0.132:10000, which is an exact match of the one assigned to the data source.

Send notable events to Splunk UBA
Use any of the following methods to send notable events from Splunk ES to Splunk UBA:

Send notable events directly from the Incident Review dashboard
Send notable events automatically from correlation search results
Send notable events directly from the Incident Review dashboard
Send notable events created by correlation search results to Splunk UBA in an ad-hoc manner from the Incident Review dashboard.

On the Incident Review dashboard in Splunk ES, locate the notable event that you want to send to Splunk UBA.
From the Actions column, select Run Adaptive Response Actions.
Click Add New Response Action and select Send to UBA.
(Optional) Type a Severity to set the score in Splunk UBA for the anomaly that might be created from the notable event. The notable event severity, if available, takes precedence over the provided value.
Click Run to run the response action and send the notable event details to Splunk UBA.
Send notable events automatically from correlation search results
You can edit an existing correlation search or create a new correlation search to automatically send correlation search results to Splunk UBA.

From the Splunk ES menu bar, select Configure > Content Management.
Click the name of a correlation search or click Create New to create a new correlation search.
Click Add New Response Action and select Send to UBA.
Type a Severity to set the score in Splunk UBA for an anomaly that might be created from the correlation search result.
For example, type 7 to represent a high severity.
Save the correlation search.



Set up Splunk UBA to send user and device association data to Splunk ES
Set up Splunk User Behavior Analytics (UBA) to send user and device association data to Splunk Enterprise Security (ES). User and device association data from Splunk UBA is visible on the Session Center dashboard in Splunk ES. See Session Center dashboard in the Use Splunk Enterprise Security manual.

Log in to the Splunk UBA management server as the caspida user using SSH.
Open the /etc/caspida/local/conf/uba-site.properties file.
Edit or create the identity.resolution.export.enabled setting and set it to true.
identity.resolution.export.enabled=true
Restart the Splunk UBA web interface service for the changes to take effect.
sudo service caspida-ui stop
sudo service caspida-ui start


Send Splunk UBA audit events to Splunk ES
Send audit events from Splunk UBA to Splunk ES so that you can maintain a history of specific actions taken by analysts and hunters in Splunk UBA. For example, if there is a need to re-examine a closed threat, you can use the audit history to determine the analyst who closed the threat.

Perform the following tasks to send audit events to the Splunk platform to be added to the _audit index.

Add or set the uba.sys.audit.push.splunk.enabled property in Splunk UBA.
Set up a search head or forwarder to receive data from Splunk UBA.
Configure the Splunk platform to receive data from the Splunk UBA output connector.
Add or set the uba.sys.audit.push.splunk.enabled property in Splunk UBA
Perform the following steps in Splunk UBA to enable audit logs to be sent to the Splunk platform:

Set the uba.sys.audit.push.splunk.enabled property in the /etc/caspida/local/conf/uba-site.properties file to true:
uba.sys.audit.push.splunk.enabled=true
Run the following command to synchronize the cluster:
/opt/caspida/bin/Caspida sync-cluster  /etc/caspida/local/conf
Run the following commands to restart Caspida services:
/opt/caspida/bin/Caspida stop
/opt/caspida/bin/Caspida start
Set up a search head or forwarder to receive data from Splunk UBA
You can choose to set up either a search head or a forwarder to receive data sent from Splunk UBA.

In Splunk UBA release 4.3.0 and lower, you can send data only to a Splunk search head.
In Splunk UBA release 4.3.1 and higher, you can send data to a Splunk search head or forwarder.
Perform the following steps to set up a search head to receive data from Splunk UBA:

In Splunk Web, select Settings > Data Inputs.
In the TCP row, click Add New.
Enter 10008 in the Port field. This is the port configured to work with Splunk UBA.
Perform the following steps to set up a forwarder to receive data from Splunk UBA:

Deploy the Splunk Add-on for Splunk UBA to the forwarder. See Deploy the Splunk Add-on for Splunk UBA.
Configure the TCP input on the Splunk forwarder. See Get data from TCP and UDP ports in the Splunk Enterprise Getting Data In manual for information on how to configure a Splunk forwarder to receive a syslog input.
Configure the Splunk platform to receive data from the Splunk UBA output connector
The connection between Splunk UBA and the Splunk platform uses TCP-SSL by default. Set up the Splunk platform to accept the encrypted connection so that the Splunk platform can receive data from the Splunk UBA output connector.

Splunk Cloud customers must work with Splunk Cloud Support to set up this connection.

The following procedure uses the Splunk default certificates and the global [SSL] stanza in the inputs.conf file. For better security, consider using your own certificates, or commercially signed certificates from a trusted certificate authority.

See About securing Splunk Enterprise with SSL in the Splunk Enterprise Securing the Splunk Platform manual.
See TCP: in the Splunk Enterprise Admin Manual for more information about configuring tcp-ssl using inputs.conf.
Perform the following steps on Splunk Enterprise:

Create a local folder under $SPLUNK_HOME/etc/apps/Splunk_TA_ueba. For example:
cd /opt/splunk/etc/apps/Splunk_TA_ueba
mkdir local
Create a file called inputs.conf and add two stanzas to match the following:
[tcp-ssl:10008]
listenOnIPv6 = no
index = ueba
sourcetype = ueba

[SSL]
serverCert = $SPLUNK_HOME/etc/auth/server.pem
sslPassword = password
In distributed deployments, deploy the changes to the inputs.conf file across all peers in your indexer cluster. See Manage common configurations across all peers in the Splunk Enterprise Managing Indexers and Clusters of Indexers manual.
Restart Splunk Enterprise.
In Splunk Web, select System > Server controls.
Click Restart Splunk.
Verify that SSL is enabled for port 10008 in $SPLUNK_HOME/var/log/splunk/splunkd.log. For example:
11-07-2019 15:07:42.661 -0800 INFO  TcpInputProc - Creating raw Acceptor for IPv4 port 10008 with SSL
Copy the root CA certificate from /opt/splunk/etc/auth/cacert.pem on the Splunk Enterprise instance to /home/caspida on the Splunk UBA management server.
Perform the following tasks on the Splunk UBA management server:

Log in to the Splunk UBA management server as the caspida user.
Ensure that $JAVA_HOME is set correctly on your system. Run the CaspidaCommonEnv.sh script to set this environment variable:
. /opt/caspida/bin/CaspidaCommonEnv.sh
Import the rootCA certificate to the Java certificate store.
On CentOS systems, use the following command:
sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/lib/security/cacerts -file ~/cacert.pem
On other Linux systems, use the following command:

sudo keytool -import -alias "splunk es" -keystore $JAVA_HOME/jre/lib/security/cacerts -file ~/cacert.pem
When prompted, type the keystore password and trust the certificate. The default keystore password is changeit.
Restart Splunk UBA. Run the following commands on the Splunk UBA management server:
/opt/caspida/bin/Caspida stop-all
/opt/caspida/bin/Caspida start-all

